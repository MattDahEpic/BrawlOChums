var websock=require("ws"),fs=require("fs"),struct=require("./boc_struct.js"),boc_handshake=require("./boc_handshake.js"),boc_trivia=require("./boc_trivia.js");console.log("Starting VoxelatedAvacado server.");var server=require("http").createServer({port:36245}),wss=new websock.Server({server:server,path:"/ws/"});
process.on("SIGINT",function(){console.log("Received SIGINT, stopping gracefully...");wss.clients.forEach(function(a){console.log("-Ended connection with "+a.upgradeReq.socket.remoteAddress+" (1001)");a.close(1001)});process.exit(1)});process.on("uncaughtException",function(a){console.log(a)});
wss.on("connection",function(a,d){console.log("+Received connection from "+a._socket.remoteAddress);a.upgradeReq=d;a.hasHandshook=!1;a.onmessage=function(b){try{var c=JSON.parse(b.data)}catch(e){a.send('{"e":"Invalid json."}');return}a.hasHandshook||boc_handshake(c,a);boc_trivia(b.data,c,a)};a.onclose=function(){"game"===a.clientType?(struct.connections.get(a.gameCode).clients.forEach(function(a){null!==a&&a.close(4002)}),struct.connections.delete(a.gameCode)):"undefined"!==typeof a.gameCode&&struct.connections.has(a.gameCode)&&
struct.connections.get(a.gameCode).clients.set(a.clientIdentifier,null)}});server.listen(36245);
