var websock=require("./node_modules/ws"),struct=require("./boc_struct.js"),boc_handshake=require("./boc_handshake.js"),boc_trivia=require("./boc_trivia.js");console.log("Starting VoxelatedAvacado server.");var wss=new websock.Server({port:36245});process.on("SIGINT",function(){console.log("Received SIGINT, stopping gracefully...");wss.clients.forEach(function(a){console.log("-Ended connection with "+a.upgradeReq.socket.remoteAddress+" (1001)");a.close(1001)});process.exit(1)});
wss.on("connection",function(a,d){console.log("+Received connection from "+a._socket.remoteAddress);a.upgradeReq=d;a.hasHandshook=!1;a.onmessage=function(b){try{var c=JSON.parse(b.data)}catch(e){a.send('{"e":"Invalid json."}');return}a.hasHandshook||boc_handshake(c,a);boc_trivia(b,c,a)};a.onclose=function(){"game"===a.clientType?(struct.connections.get(a.gameCode).clients.forEach(function(a){a.close(4002)}),struct.connections.delete(a.gameCode)):"undefined"!==typeof a.gameCode&&struct.connections.has(a.gameCode)&&
struct.connections.get(a.gameCode).clients.set(a.clientIdentifier,null)}});
