var websock=require("./node_modules/ws"),HashMap=require("./node_modules/hashmap"),jsonparse=require("./node_modules/jsonparse"),randomstring=require("./node_modules/randomstring"),Session=function(a){this.server=a;this.clients=[]};console.log("Starting VoxelatedAvacado server.");var connections=new HashMap,json=new jsonparse,wss=new websock.Server({port:36245});
process.on("SIGINT",function(){console.log("Received SIGINT, stopping gracefully...");wss.clients.forEach(function(a){console.log("-Ended connection with "+a.upgradeReq.socket.remoteAddress+" (1001)");a.close(1001)});process.exit(1)});
wss.on("connection",function(a,d){console.log("+Received connection from "+a._socket.remoteAddress);a.upgradeReq=d;a.hasHandshook=!1;a.onmessage=function(c){try{var b=JSON.parse(c.data)}catch(e){a.send('{"e":"Invalid json."}');return}if(!a.hasHandshook)if(a.hasHandshook=!0,"game"===b.type)for(a.clientType="game";;){if(c=randomstring.generate({length:4,readable:!0,charset:"alphanumeric",capitalization:"uppercase"}),!connections.has(c)){a.send('{"code":"'+c+'"}');a.gameCode=c;connections.set(c,new Session(a));
break}}else"client"===b.type?"undefined"!==typeof b.code&&connections.has(b.code)?"undefined"===typeof b.name?(a.send('{"e":"Invalid or nonexistant name."}'),console.log("-Ended connection with "+a._socket.remoteAddress+" (4003)"),a.close(4003)):(a.clientType="client",a.gameCode=b.code,a.playerName=b.name,connections.get(b.code).clients.push(a),a.send('{"joingame":"true"}'),connections.get(b.code).server.send('{"join":"'+b.name+'"}')):(a.send('{"e":"Invalid game code."}'),console.log("-Ended connection with "+
a._socket.remoteAddress+" (4001)"),a.close(4001)):(a.send('{"e":"Invalid type provided on handshake message."}'),console.log("-Ended connection with "+a._socket.remoteAddress+" (4000)"),a.close(4E3))};a.onclose=function(){"game"===a.clientType&&(connections.get(a.gameCode).clients.forEach(function(a){a.close(4002)}),connections.delete(a.gameCode))}});
