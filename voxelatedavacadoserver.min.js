var websock=require("./node_modules/ws"),HashMap=require("./node_modules/hashmap"),jsonparse=require("./node_modules/jsonparse"),randomstring=require("./node_modules/randomstring"),Session=function(a){this.server=a;this.clients=[]};console.log("Starting VoxelatedAvacado server.");var connections=new HashMap,json=new jsonparse,wss=new websock.Server({port:36245});
process.on("SIGINT",function(){console.log("Recieved SIGINT, stopping gracefully...");wss.clients.forEach(function(a){console.log("-Ended connection with "+a.upgradeReq.socket.remoteAddress+" (1001)");a.closeReasonCode=1001;a.close()});process.exit(1)});
wss.on("connection",function(a,d){console.log("+Recieved connection from "+a._socket.remoteAddress);a.upgradeReq=d;a.hasHandshook=!1;a.onmessage=function(c){try{var b=JSON.parse(c.data)}catch(e){a.send('{"e":"Invalid json."}');return}if(!a.hasHandshook)if(a.hasHandshook=!0,"game"===b.type)for(a.clientType="game";;){if(c=randomstring.generate({length:4,readable:!0,charset:"alphanumeric",capitalization:"uppercase"}),!connections.has(c)){a.send('{"code":"'+c+'"}');a.gameCode=c;connections.set(c,new Session(a));
break}}else"client"===b.type?("undefined"!==typeof b.code&&connections.has(b.code)||(a.send('{"e":"Invalid game code."}'),a.closeReasonCode=4001,a.closeDescription="Invalid game code.",console.log("-Ended connection with "+a._socket.remoteAddress+" (4001)"),a.close()),"undefined"!==typeof b.name&&(a.clientType="client",a.gameCode=b.code,a.playerName=b.name,connections.get(b.code).clients.add(a),a.send('{"joingame":"true"}'))):(a.send('{"e":"Invalid type provided on handshake message."}'),a.closeReasonCode=
4E3,a.closeDescription="Invalid type provided on handshake message.",console.log("-Ended connection with "+a._socket.remoteAddress+" (4000)"),a.close())};a.onclose=function(){console.log("-Ended connection with "+a.upgradeReq.socket.remoteAddress+" (Client Closed)")}});
